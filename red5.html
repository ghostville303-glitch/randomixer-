<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>StudioVibe OS v4.5</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --accent: #ffffff; --bg: #000000; --panel: rgba(255, 255, 255, 0.04); }
        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; outline: none; }
        body { 
            background: var(--bg); color: white; font-family: 'Inter', -apple-system, sans-serif; 
            margin: 0; height: 100vh; display: flex; align-items: center; justify-content: center;
            overflow: hidden; touch-action: none;
        }

        #bg-glow {
            position: fixed; top: 50%; left: 50%; width: 140vw; height: 140vw;
            background: radial-gradient(circle, var(--accent) 0%, transparent 65%);
            transform: translate(-50%, -50%) scale(1); opacity: 0.08; z-index: -1;
            transition: opacity 0.5s ease; pointer-events: none;
        }

        .os-container {
            width: 90vw; max-width: 380px; height: 85vh;
            background: var(--panel); backdrop-filter: blur(50px); -webkit-backdrop-filter: blur(50px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 45px;
            display: flex; flex-direction: column; padding: 25px; position: relative;
            box-shadow: 0 50px 100px rgba(0,0,0,0.9); z-index: 10;
        }

        #viz-canvas {
            position: absolute; bottom: 150px; left: 0; width: 100%; height: 100px;
            z-index: -1; opacity: 0.6; pointer-events: none;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .badge { font-size: 9px; font-weight: 900; letter-spacing: 3px; color: var(--accent); opacity: 0.6; }

        .art-zone { position: relative; width: 220px; height: 220px; margin: 0 auto 30px; }
        .art-box {
            width: 100%; height: 100%; border-radius: 40px; background: #080808;
            display: flex; align-items: center; justify-content: center; font-size: 80px;
            border: 1px solid rgba(255,255,255,0.05); transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .playing .art-box { transform: scale(1.02); border-color: var(--accent); box-shadow: 0 20px 60px rgba(255,255,255,0.05); }

        .meta { text-align: center; margin-bottom: 25px; }
        .meta h1 { margin: 0; font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
        .meta p { margin: 5px 0 0; opacity: 0.4; font-size: 10px; text-transform: uppercase; letter-spacing: 2px; }

        .scrubber-cont { margin-bottom: 25px; cursor: pointer; padding: 10px 0; }
        .rail { background: rgba(255,255,255,0.1); height: 4px; border-radius: 10px; position: relative; }
        .fill { background: var(--accent); width: 0%; height: 100%; border-radius: 10px; transition: width 0.1s linear; }
        .time { display: flex; justify-content: space-between; font-size: 10px; opacity: 0.4; margin-top: 10px; font-family: 'JetBrains Mono', monospace; }

        .controls { display: grid; grid-template-columns: repeat(5, 1fr); align-items: center; gap: 10px; }
        .btn { background: none; border: none; color: white; cursor: pointer; transition: 0.2s; padding: 10px; opacity: 0.7; font-size: 18px; }
        .btn:active { transform: scale(0.9); opacity: 1; }
        .play-btn { 
            width: 65px; height: 65px; border-radius: 50%; background: var(--accent); color: black;
            font-size: 24px; display: flex; align-items: center; justify-content: center; opacity: 1; margin: 0 auto;
        }

        #vault {
            position: absolute; inset: 0; background: #000; z-index: 100;
            border-radius: 45px; display: none; flex-direction: column; padding: 30px;
        }
        .row { padding: 18px 0; border-bottom: 1px solid #111; display: flex; justify-content: space-between; cursor: pointer; }
        .add-btn { position: absolute; bottom: 30px; right: 30px; background: var(--accent); color: black; width: 50px; height: 50px; border-radius: 25px; font-weight: bold; }
    </style>
</head>
<body>

<div id="bg-glow"></div>

<div class="os-container" id="app">
    <canvas id="viz-canvas"></canvas>
    <div class="header">
        <div class="badge" id="now-playing-badge">STUDIOVIBE // SYSTEM READY</div>
        <button class="btn" onclick="openVault()">üìÇ</button>
    </div>

    <div class="art-zone">
        <div class="art-box" id="art">üíø</div>
    </div>

    <div class="meta">
        <h1 id="title">SELECT TRACK</h1>
        <p id="artist">STATION IDLE</p>
    </div>

    <div class="scrubber-cont" onclick="seek(event)">
        <div class="rail"><div class="fill" id="fill"></div></div>
        <div class="time">
            <span id="cur">0:00</span>
            <span id="dur">0:00</span>
        </div>
    </div>

    <div class="controls">
        <button class="btn" onclick="prev()">‚èÆ</button>
        <button class="btn" onclick="jump(-10)">‚è™</button>
        <button class="btn play-btn" onclick="togglePlay()" id="pIco">‚ñ∂</button>
        <button class="btn" onclick="jump(10)">‚è©</button>
        <button class="btn" onclick="next()">‚è≠</button>
    </div>

    <div id="vault">
        <div style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 25px;">
            <h2 style="font-size: 14px; letter-spacing: 2px;">LIBRARY</h2>
            <button class="btn" onclick="openVault()">‚úï</button>
        </div>
        <div id="list" style="overflow-y:auto; flex:1;"></div>
        <input type="file" id="fileInput" hidden accept="audio/*" onchange="handleFile(event)">
        <button class="btn add-btn" onclick="document.getElementById('fileInput').click()">Ôºã</button>
    </div>
</div>

<audio id="player" crossOrigin="anonymous"></audio>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand(); 

    const audio = document.getElementById('player');
    const fill = document.getElementById('fill');
    const glow = document.getElementById('bg-glow');
    const canvas = document.getElementById('viz-canvas');
    const ctx = canvas.getContext('2d');

    let isPlaying = false, idx = 0;
    let aCtx, analyser, data, source;

    let tracks = [
        { title: "FEAR", src: "01 FEAR.mp3", icon: "üåë", color: "#ffffff" },
        { title: "HOME", src: "02 HOME.mp3", icon: "üè†", color: "#f2f2f2" },
        { title: "WHO I WAS", src: "03 WHO I WAS.mp3", icon: "üë§", color: "#ff4d4d" }
    ];

    function initAudio() {
        if (aCtx) return;
        aCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = aCtx.createAnalyser();
        source = aCtx.createMediaElementSource(audio);
        source.connect(analyser); analyser.connect(aCtx.destination);
        analyser.fftSize = 128; 
        data = new Uint8Array(analyser.frequencyBinCount);
        render();
    }

    function render() {
        requestAnimationFrame(render);
        analyser.getByteFrequencyData(data);
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        const bWidth = (canvas.width / data.length) * 2;
        let x = 0;
        
        // Dynamic Glow
        const bass = data[2] / 255;
        glow.style.transform = `translate(-50%, -50%) scale(${1 + bass * 0.3})`;
        glow.style.opacity = 0.05 + (bass * 0.1);

        for (let i = 0; i < data.length; i++) {
            const h = (data[i] / 255) * canvas.height;
            ctx.fillStyle = tracks[idx]?.color || '#ffffff';
            ctx.globalAlpha = 0.4;
            ctx.fillRect(x, canvas.height - h, bWidth - 2, h);
            x += bWidth;
        }
    }

    function load(i) {
        if(!tracks[i]) return;
        const t = tracks[i];
        document.getElementById('title').innerText = t.title;
        document.getElementById('artist').innerText = "STUDIOVIBE REPLAY";
        document.getElementById('art').innerText = t.icon;
        document.getElementById('now-playing-badge').innerText = `PLAYING // ${t.title}`;
        document.documentElement.style.setProperty('--accent', t.color);
        audio.src = t.src;
        idx = i;
    }

    function togglePlay() {
        if (!aCtx) initAudio();
        if (audio.src.includes('undefined')) return;
        
        if (isPlaying) {
            audio.pause();
            document.getElementById('pIco').innerText = "‚ñ∂";
            document.getElementById('app').classList.remove('playing');
        } else {
            audio.play();
            document.getElementById('pIco').innerText = "‚è∏";
            document.getElementById('app').classList.add('playing');
        }
        isPlaying = !isPlaying;
        tg.HapticFeedback.impactOccurred('medium');
    }

    function handleFile(e) {
        const file = e.target.files[0];
        if (file) {
            const url = URL.createObjectURL(file);
            const newTrack = { title: file.name.replace(/\.[^/.]+$/, ""), src: url, icon: "üéµ", color: "#00ffcc" };
            tracks.push(newTrack);
            idx = tracks.length - 1;
            load(idx);
            openVault();
            togglePlay();
        }
    }

    function next() { idx = (idx + 1) % tracks.length; load(idx); if(isPlaying) audio.play(); }
    function prev() { idx = (idx - 1 + tracks.length) % tracks.length; load(idx); if(isPlaying) audio.play(); }
    function jump(s) { audio.currentTime += s; }
    function seek(e) { audio.currentTime = (e.offsetX / e.currentTarget.clientWidth) * audio.duration; }

    function openVault() {
        const v = document.getElementById('vault');
        v.style.display = v.style.display === 'flex' ? 'none' : 'flex';
        document.getElementById('list').innerHTML = tracks.map((t, i) => `
            <div class="row" onclick="load(${i}); openVault(); togglePlay();">
                <span><b>${t.title}</b></span><span>${t.icon}</span>
            </div>
        `).join('');
    }

    audio.addEventListener('timeupdate', () => {
        const p = (audio.currentTime / audio.duration) * 100;
        fill.style.width = p + "%";
        document.getElementById('cur').innerText = fmt(audio.currentTime);
        document.getElementById('dur').innerText = fmt(audio.duration);
    });

    function fmt(s) {
        if (isNaN(s)) return "0:00";
        const m = Math.floor(s/60), sec = Math.floor(s%60);
        return `${m}:${sec < 10 ? '0' : ''}${sec}`;
    }

    canvas.width = 400; canvas.height = 100;
    load(0);
</script>
</body>
</html>
